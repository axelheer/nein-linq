version: 2.1.1-ci.{build}

image: Visual Studio 2017

build_script:
  - cmd: set build_options=/p:VersionSuffix=ci.%appveyor_build_number%
  - cmd: if [%appveyor_repo_branch%]==[release] set build_options=/p:VersionSuffix=
  - cmd: dotnet --info
  - cmd: dotnet restore %build_options%
  - cmd: dotnet build --configuration Release %build_options%
  - cmd: dotnet pack --configuration Release --include-symbols %build_options%

test_script:
  - cmd: if not exist TestResults mkdir TestResults
  - cmd: set OpenCover=%UserProfile%\.nuget\packages\OpenCover\4.6.519\tools\OpenCover.Console.exe
  - cmd: set ReportGenerator=%UserProfile%\.nuget\packages\ReportGenerator\2.5.8\tools\ReportGenerator.exe
  - cmd: '"%OpenCover%" -target:dotnet.exe -targetargs:"test test\NeinLinq.Tests\NeinLinq.Tests.csproj --configuration Release --framework net461" -searchdirs:test\NeinLinq.Tests\bin\Release\net461 -output:TestResults\NeinLinq.netframework.report.xml -register:user -filter:"+[NeinLinq*]* -[NeinLinq.Fakes]* -[NeinLinq.Tests]*" -returntargetcode -oldstyle'
  - cmd: '"%OpenCover%" -target:dotnet.exe -targetargs:"test test\NeinLinq.Tests\NeinLinq.Tests.csproj --configuration Release --framework netcoreapp1.1" -searchdirs:test\NeinLinq.Tests\bin\Release\netcoreapp1.1 -output:TestResults\NeinLinq.netcoreapp.report.xml -register:user -filter:"+[NeinLinq*]* -[NeinLinq.Fakes]* -[NeinLinq.Tests]*" -returntargetcode -oldstyle'
  - cmd: '"%ReportGenerator%" -reports:TestResults\*.report.xml -targetdir:TestResults\report -reporttypes:Badges;Html'

artifacts:
  - path: 'src\**\*.nupkg'
  - path: TestResults

deploy:
  - provider: Environment
    name: blob.core.windows.net
    on:
      branch: master
  - provider: Environment
    name: nuget.org
    on:
      branch: release
