version: 2.2.1-ci.{build}

image: Visual Studio 2017

before_build:
  - cmd: set build_options=--configuration Release --version-suffix ci.%appveyor_build_number%
  - cmd: if [%appveyor_repo_branch%]==[release] set build_options=--configuration Release

build_script:
  - cmd: dotnet --info
  - cmd: dotnet build %build_options%
  - cmd: dotnet pack %build_options% --include-symbols

before_test:
  - cmd: if not exist TestResults mkdir TestResults
  - cmd: set OpenCover=%UserProfile%\.nuget\packages\OpenCover\4.6.519\tools\OpenCover.Console.exe
  - cmd: set ReportGenerator=%UserProfile%\.nuget\packages\ReportGenerator\3.0.2\tools\ReportGenerator.exe

test_script:
  - cmd: dotnet clean --configuration Release
  - cmd: dotnet build %build_options% /p:DebugType=Full
  - cmd: '"%OpenCover%" -target:dotnet.exe -targetargs:"test test\NeinLinq.Tests\NeinLinq.Tests.csproj --configuration Release --framework net452 --logger trx;LogFileName=NeinLinq.netframework45.trx --no-build --results-directory ..\..\TestResults" -searchdirs:test\NeinLinq.Tests\bin\Release\net452 -output:TestResults\NeinLinq.netframework45.report.xml -register:user -filter:"+[NeinLinq*]* -[NeinLinq.Fakes]* -[NeinLinq.Tests]*" -returntargetcode -oldstyle'
  - cmd: '"%OpenCover%" -target:dotnet.exe -targetargs:"test test\NeinLinq.Tests\NeinLinq.Tests.csproj --configuration Release --framework net461 --logger trx;LogFileName=NeinLinq.netframework46.trx --no-build --results-directory ..\..\TestResults" -searchdirs:test\NeinLinq.Tests\bin\Release\net461 -output:TestResults\NeinLinq.netframework46.report.xml -register:user -filter:"+[NeinLinq*]* -[NeinLinq.Fakes]* -[NeinLinq.Tests]*" -returntargetcode -oldstyle'
  - cmd: '"%OpenCover%" -target:dotnet.exe -targetargs:"test test\NeinLinq.Tests\NeinLinq.Tests.csproj --configuration Release --framework netcoreapp1.1 --logger trx;LogFileName=NeinLinq.netcore1.trx --no-build --results-directory ..\..\TestResults" -searchdirs:test\NeinLinq.Tests\bin\Release\netcoreapp1.1 -output:TestResults\NeinLinq.netcore1.report.xml -register:user -filter:"+[NeinLinq*]* -[NeinLinq.Fakes]* -[NeinLinq.Tests]*" -returntargetcode -oldstyle'
  - cmd: '"%OpenCover%" -target:dotnet.exe -targetargs:"test test\NeinLinq.Tests\NeinLinq.Tests.csproj --configuration Release --framework netcoreapp2.0 --logger trx;LogFileName=NeinLinq.netcore2.trx --no-build --results-directory ..\..\TestResults" -searchdirs:test\NeinLinq.Tests\bin\Release\netcoreapp2.0 -output:TestResults\NeinLinq.netcore2.report.xml -register:user -filter:"+[NeinLinq*]* -[NeinLinq.Fakes]* -[NeinLinq.Tests]*" -returntargetcode -oldstyle'
  - cmd: '"%ReportGenerator%" -reports:TestResults\*.report.xml -targetdir:TestResults\report -reporttypes:Badges;Html'

artifacts:
  - path: 'src\**\*.nupkg'
  - path: TestResults

deploy:
  - provider: Environment
    name: blob.core.windows.net
    on:
      branch: master
  - provider: Environment
    name: nuget.org
    on:
      branch: release
